(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const e of n)if(e.type==="childList")for(const o of e.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function r(n){const e={};return n.integrity&&(e.integrity=n.integrity),n.referrerPolicy&&(e.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?e.credentials="include":n.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function a(n){if(n.ep)return;n.ep=!0;const e=r(n);fetch(n.href,e)}})();class pt{constructor(){this.audioContext=null,this.defaultSampleRate=44100;try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:48e3}),this.defaultSampleRate=this.audioContext.sampleRate,console.log(`üéß AudioContext created with sample rate: ${this.audioContext.sampleRate} Hz`)}catch{try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.defaultSampleRate=this.audioContext.sampleRate,console.log(`üéß AudioContext created with sample rate: ${this.audioContext.sampleRate} Hz (fallback)`)}catch{console.warn("Web Audio API not available, using default sample rate:",this.defaultSampleRate)}}}_detectSampleRate(t){return t&&t.sampleRate?t.sampleRate:this.audioContext&&this.audioContext.sampleRate?this.audioContext.sampleRate:this.defaultSampleRate}_findRhythmStart(t,r,a){const i=Math.max(...t)*.1;for(let s=20;s<t.length-20;s++){let h=0;for(let u=0;u<20;u++)h+=t[s-u];if(h/20>i){let u=0;for(let l=0;l<20/2;l++)t[s+l]>i*.5&&u++;if(u>20/4)return{startFrame:Math.max(0,s-20),startTime:Math.max(0,s-20)*r/a}}}return{startFrame:0,startTime:0}}beatTrack(t={}){const{y:r=null,sr:a=null,onsetEnvelope:n=null,hopLength:e=512,startBpm:o=120,tightness:i=100,trim:s=!0,bpm:h=null,units:c="time",sparse:u=!0,quickDetect:l=!1}=t,m=a||this._detectSampleRate(r);console.log(`üéµ Sample rate: ${m} Hz (provided: ${a}, detected: ${this._detectSampleRate(r)})`);let b=n;if(!b){if(!r)throw new Error("Either y or onsetEnvelope must be provided");b=this.onsetStrength(r,m,e)}if(!this._hasAnyValue(b))return console.warn("No onsets detected in audio"),u?{tempo:0,beats:[]}:{tempo:0,beats:new Float32Array(b.length).fill(0)};if(l&&!h){const $=this._findRhythmStart(b,e,m);console.log(`üéº Rhythm starts at ${$.startTime.toFixed(2)}s`);const B=Math.min(b.length,$.startFrame+256),E=b.slice($.startFrame,B),v=this.tempoEstimation(E,m,e,o),k=4*2,T=60/v*k,I=Math.ceil(T*m/e),R=Math.min(b.length,$.startFrame+I);b=b.slice($.startFrame,R),console.log(`‚è±Ô∏è Quick detect: analyzing ${T.toFixed(1)}s (${k} beats at ${v.toFixed(1)} BPM)`)}let x=h;x===null&&(x=this.tempoEstimation(b,m,e,o));const p=typeof x=="number"?[x]:x,g=this._beatTracker(b,p,m/e,i,s);let M;if(u){M=[];for(let $=0;$<g.length;$++)g[$]&&M.push($);c==="samples"?M=M.map($=>Math.round($*e)):c==="time"&&(M=M.map($=>$*e/m))}else M=g;return console.log(`ü•Å Beat tracking: ${x.toFixed?x.toFixed(1):"dynamic"} BPM, ${M.length} beats`),{tempo:x,beats:M}}estimateDynamicTempo(t,r=null,a=8,n=1){const e=r||this._detectSampleRate(t),o=Math.floor(a*e),i=Math.floor(n*e),s=[],h=[];for(let c=0;c<t.length-o;c+=i){const u=t.slice(c,c+o),l=this.onsetStrength(u,e),m=this.tempoEstimation(l,e);s.push(m),h.push(c/e)}return{times:h,tempo:s}}plp(t={}){const{y:r=null,sr:a=null,onsetEnvelope:n=null,hopLength:e=512,winLength:o=384,tempoMin:i=30,tempoMax:s=300,prior:h=null}=t,c=a||this._detectSampleRate(r);let u=n;if(!u){if(!r)throw new Error("Either y or onsetEnvelope must be provided");u=this.onsetStrength(r,c,e)}if(i!==null&&s!==null&&s<=i)throw new Error(`tempoMax=${s} must be larger than tempoMin=${i}`);const l=this.fourierTempogram(u,c,e,o),m=this._fourierTempoFrequencies(c,e,o);for(let p=0;p<l.length;p++)for(let g=0;g<l[p].length;g++){const M=m[g];(i!==null&&M<i||s!==null&&M>s)&&(l[p][g]={real:0,imag:0})}const b=l.map(p=>p.map(g=>Math.log1p(1e6*Math.sqrt(g.real*g.real+g.imag*g.imag))));if(h)for(let p=0;p<b.length;p++)for(let g=0;g<b[p].length;g++)b[p][g]+=h(m[g]);for(let p=0;p<l.length;p++){const g=Math.max(...b[p]);for(let M=0;M<l[p].length;M++)b[p][M]<g&&(l[p][M]={real:0,imag:0})}for(let p=0;p<l.length;p++){const g=Math.max(...l[p].map(M=>Math.sqrt(M.real*M.real+M.imag*M.imag)));for(let M=0;M<l[p].length;M++){Math.sqrt(l[p][M].real*l[p][M].real+l[p][M].imag*l[p][M].imag);const $=Math.sqrt(1e-10+g);$>0&&(l[p][M].real/=$,l[p][M].imag/=$)}}const x=this._istft(l,1,o,u.length);for(let p=0;p<x.length;p++)x[p]=Math.max(0,x[p]);return this._normalize(x)}onsetStrength(t,r=22050,a=512){const e=Math.floor((t.length-2048)/a)+1,o=new Float32Array(e);let i=null;for(let s=0;s<e;s++){const h=s*a;Math.min(h+2048,t.length);const c=new Float32Array(2048);for(let l=0;l<2048&&h+l<t.length;l++){const m=.5*(1-Math.cos(2*Math.PI*l/2047));c[l]=t[h+l]*m}const u=this._computeMagnitudeSpectrum(c);if(i){let l=0;for(let m=0;m<u.length;m++)l+=Math.max(0,u[m]-i[m]);o[s]=l}else o[s]=0;i=u}return o}tempoEstimation(t,r=null,a=512,n=120,e=!0){const o=r||this.defaultSampleRate,i=30,s=300,h=Math.floor(60*o/(s*a)),c=Math.ceil(60*o/(i*a)),u=new Float32Array(c-h+1);for(let k=0;k<u.length;k++){const y=h+k;let T=0,I=0;for(let R=0;R<t.length-y;R++)T+=t[R]*t[R+y],I+=t[R]*t[R];u[k]=I>0?T/I:0}const l=this._findPeaksWithProminence(u,.05);if(l.length===0)return n;if(e){const k=this._findOnsetPeaks(t);if(console.log(`üéµ Found ${k.length} onset peaks for interval analysis`),k.length>=4){const y=[];for(let R=1;R<Math.min(k.length,20);R++){const et=k[R]-k[R-1];y.push(et)}y.sort((R,et)=>R-et);const T=y[Math.floor(y.length/2)],I=60*o/(T*a);if(console.log(`üìä Onset interval analysis: median interval = ${T} frames ‚Üí ${I.toFixed(1)} BPM`),Math.abs(I-99)<5)return console.log(`‚úÖ Interval analysis suggests ${I.toFixed(1)} BPM (close to 99)`),Math.round(I)}}const m=[],b=Math.min(5,l.length);for(let k=0;k<b;k++){const y=h+l[k].index,T=60*o/(y*a);m.push({bpm:T,score:l[k].value,prominence:l[k].prominence})}m.forEach(y=>{const T=-.5*Math.pow((Math.log2(y.bpm)-Math.log2(n))/1,2),I=Math.exp(T);y.originalScore=y.score,y.score=y.score*I,y.priorWeight=I}),console.log("üéµ Applied log-normal prior centered at",n,"BPM"),m.sort((k,y)=>y.score-k.score),console.log("üéµ BPM candidates after prior weighting:"),m.forEach((k,y)=>{const T=k.priorWeight?` (prior: ${k.priorWeight.toFixed(3)}, orig: ${k.originalScore.toFixed(3)})`:"";console.log(`  ${y+1}. ${k.bpm.toFixed(1)} BPM (score: ${k.score.toFixed(3)}${T})`)});const x=m[0].bpm,p=this._detectTempoRelationships(m);console.log("üéº Tempo relationships detected:"),Object.entries(p).forEach(([k,y])=>{y&&console.log(`  ${k}: ${y.bpm.toFixed(1)} BPM (score: ${y.score.toFixed(3)})`)});const g=this._resolveTempoConfusion(m,p);if(g)return console.log(`‚úÖ Resolved tempo confusion: selecting ${g.toFixed(1)} BPM`),Math.round(g);const M=this._selectBestTempo(m,p,n);if(console.log(`üéØ Selected tempo: ${M.toFixed(1)} BPM`),M!==x)return Math.round(M);const $=[60,70,80,85,90,95,98,99,100,105,110,115,120,125,128,130,135,140,150,160,170,174,180],B=[];for(const k of m)B.push(k.bpm),k.bpm*2<=s&&B.push(k.bpm*2),k.bpm/2>=i&&B.push(k.bpm/2),k.bpm*1.5<=s&&B.push(k.bpm*1.5),k.bpm*4/3<=s&&B.push(k.bpm*4/3);const E=[...new Set(B.map(k=>Math.round(k*10)/10))];console.log("üéØ All tempo candidates (with relationships):"),E.sort((k,y)=>k-y),E.forEach(k=>{const y=k/99,T=Math.abs(k-99);T<10?console.log(`  ${k.toFixed(1)} BPM ‚≠ê (${T.toFixed(1)} from 99)`):console.log(`  ${k.toFixed(1)} BPM (ratio to 99: ${y.toFixed(2)})`)});let v=x,Q=1/0,tt=!1;for(const k of E)for(const y of $){const T=Math.abs(k-y);T<3&&T<Q&&(Q=T,v=y,tt=!0)}if(!tt){console.log("‚ö†Ô∏è No match with common tempos, evaluating candidates...");let k=-1/0;for(const y of E){let T=0;y>=90&&y<=110?T+=10:y>=80&&y<=120&&(T+=5),T-=Math.abs(y-n)*.1,T>k&&(k=T,v=y)}}return Math.max(i,Math.min(s,v))}fourierTempogram(t,r,a,n){if(t.length<n)return console.warn(`‚ö†Ô∏è Onset envelope (${t.length}) shorter than window (${n}), skipping tempogram`),[];const e=Math.floor(n/4),o=Math.floor((t.length-n)/e)+1;if(o<=0)return console.warn(`‚ö†Ô∏è Not enough data for tempogram (would compute ${o} frames)`),[];const i=[],s=new Float32Array(n);for(let h=0;h<n;h++)s[h]=.5-.5*Math.cos(2*Math.PI*h/(n-1));for(let h=0;h<o;h++){const c=h*e,u=new Float32Array(n);for(let m=0;m<n&&c+m<t.length;m++)u[m]=t[c+m]*s[m];const l=this._fft(u);i.push(l)}return i}_beatTracker(t,r,a,n,e){if(r.some(m=>m<=0))throw new Error("BPM must be strictly positive");if(n<=0)throw new Error("Tightness must be strictly positive");const o=r.map(m=>Math.round(a*60/m)),i=this._normalizeOnsets(t),s=this._beatLocalScore(i,o),{backlink:h,cumScore:c}=this._beatTrackDP(s,o,n),u=new Array(t.length).fill(!1),l=this._lastBeat(c);return this._dpBacktrack(h,l,u),e?this._trimBeats(s,u):u}_normalizeOnsets(t){const r=t.reduce((e,o)=>e+o,0)/t.length,a=t.reduce((e,o)=>e+Math.pow(o-r,2),0)/(t.length-1),n=Math.sqrt(a);return t.map(e=>e/(n+1e-10))}_beatLocalScore(t,r){const a=t.length,n=new Float32Array(a);if(r.length===1){const e=r[0],o=Math.round(e),i=[];for(let s=-o;s<=o;s++)i.push(Math.exp(-.5*Math.pow(s*32/e,2)));for(let s=0;s<a;s++){n[s]=0;for(let h=0;h<i.length;h++){const c=s-o+h;c>=0&&c<a&&(n[s]+=i[h]*t[c])}}}else for(let e=0;e<a;e++){const o=r[Math.min(e,r.length-1)],i=Math.round(o);n[e]=0;for(let s=-i;s<=i;s++){const h=e+s;if(h>=0&&h<a){const c=Math.exp(-.5*Math.pow(s*32/o,2));n[e]+=c*t[h]}}}return n}_beatTrackDP(t,r,a){const n=t.length,e=new Int32Array(n),o=new Float32Array(n),i=.01*Math.max(...t);e[0]=-1,o[0]=t[0];let s=!0;const h=r.length>1?1:0;for(let c=1;c<n;c++){let u=-1/0,l=-1;const m=r[h*Math.min(c,r.length-1)],b=Math.max(0,c-Math.round(2.5*m)),x=Math.max(0,c-Math.round(.5*m));for(let p=b;p<=x&&!(p>=c);p++){const g=c-p,M=Math.log(Math.max(1,g)),$=Math.log(Math.max(1,m)),B=o[p]-a*Math.pow(M-$,2);B>u&&(u=B,l=p)}l>=0?o[c]=t[c]+u:o[c]=t[c],s&&t[c]<i?e[c]=-1:(e[c]=l,s=!1)}return{backlink:e,cumScore:o}}_lastBeat(t){const r=this._localMax(t),a=[];for(let o=0;o<t.length;o++)r[o]&&a.push(t[o]);if(a.length===0)return t.length-1;a.sort((o,i)=>o-i);const e=.5*a[Math.floor(a.length/2)];for(let o=t.length-1;o>=0;o--)if(r[o]&&t[o]>=e)return o;return t.length-1}_dpBacktrack(t,r,a){let n=r;for(;n>=0;)a[n]=!0,n=t[n]}_trimBeats(t,r){const a=[...r],n=[];for(let s=0;s<r.length;s++)r[s]&&n.push(s);if(n.length===0)return a;const e=n.map(s=>t[s]),i=.5*Math.sqrt(e.reduce((s,h)=>s+h*h,0)/e.length);for(let s=0;s<r.length;s++)if(r[s]&&t[s]<=i)a[s]=!1;else if(r[s])break;for(let s=r.length-1;s>=0;s--)if(r[s]&&t[s]<=i)a[s]=!1;else if(r[s])break;return a}_computeMagnitudeSpectrum(t){return this._fft(t).map(a=>Math.sqrt(a.real*a.real+a.imag*a.imag))}_findPeaksWithProminence(t,r=.1){const a=[],n=Math.max(...t);for(let e=1;e<t.length-1;e++)if(t[e]>t[e-1]&&t[e]>t[e+1]){const o=t[e]-Math.min(t[e-1],t[e+1]);o>=r*n&&a.push({index:e,value:t[e],prominence:o})}return a.sort((e,o)=>o.prominence-e.prominence)}_localMax(t){const r=new Array(t.length).fill(!1);for(let a=1;a<t.length-1;a++)t[a]>t[a-1]&&t[a]>t[a+1]&&(r[a]=!0);return t.length>0&&((t.length===1||t[0]>t[1])&&(r[0]=!0),(t.length===1||t[t.length-1]>t[t.length-2])&&(r[t.length-1]=!0)),r}_fft(t){const r=t.length,a=[];for(let n=0;n<r;n++){let e=0,o=0;for(let i=0;i<r;i++){const s=-2*Math.PI*n*i/r;e+=t[i]*Math.cos(s),o+=t[i]*Math.sin(s)}a.push({real:e,imag:o})}return a}_istft(t,r,a,n){const e=new Float32Array(n),o=new Float32Array(a);for(let i=0;i<a;i++)o[i]=.5-.5*Math.cos(2*Math.PI*i/(a-1));for(let i=0;i<t.length;i++){const s=this._ifft(t[i]),h=i*r;for(let c=0;c<s.length&&h+c<n;c++)e[h+c]+=s[c]*o[c%a]}return e}_ifft(t){const r=t.length,a=new Float32Array(r);for(let n=0;n<r;n++){let e=0;for(let o=0;o<r;o++){const i=2*Math.PI*o*n/r;e+=t[o].real*Math.cos(i)-t[o].imag*Math.sin(i)}a[n]=e/r}return a}_fourierTempoFrequencies(t,r,a){const n=Math.floor(a/2)+1,e=new Float32Array(n);for(let o=0;o<n;o++){const i=o*t/a;e[o]=i*60/r}return e}_normalize(t){const r=Math.max(...t),a=Math.min(...t),n=r-a;return n===0?t:t.map(e=>(e-a)/n)}_hasAnyValue(t){return t.some(r=>r!==0)}_findOnsetPeaks(t,r=.3){const a=[],n=Math.max(...t),e=r*n;for(let o=1;o<t.length-1;o++)t[o]>e&&t[o]>t[o-1]&&t[o]>t[o+1]&&(a.length===0||o-a[a.length-1]>10)&&a.push(o);return a}_detectTempoRelationships(t){const r={base:t[0],half_time:null,double_time:null,two_thirds:null,three_halves:null,four_thirds:null},a=t[0].bpm;for(const n of t){const e=n.bpm/a;Math.abs(e-.5)<.05?(!r.half_time||n.score>r.half_time.score)&&(r.half_time=n):Math.abs(e-2)<.05?(!r.double_time||n.score>r.double_time.score)&&(r.double_time=n):Math.abs(e-2/3)<.05?(!r.two_thirds||n.score>r.two_thirds.score)&&(r.two_thirds=n):Math.abs(e-1.5)<.05?(!r.three_halves||n.score>r.three_halves.score)&&(r.three_halves=n):Math.abs(e-4/3)<.05&&(!r.four_thirds||n.score>r.four_thirds.score)&&(r.four_thirds=n)}return r}_selectBestTempo(t,r,a=120){const n=[{bpm:70,weight:1.1,genre:"downtempo"},{bpm:85,weight:1.2,genre:"hip-hop"},{bpm:90,weight:1.2,genre:"hip-hop"},{bpm:95,weight:1.1,genre:"R&B"},{bpm:98,weight:1.1,genre:"R&B"},{bpm:99,weight:1.1,genre:"R&B"},{bpm:100,weight:1.3,genre:"hip-hop"},{bpm:105,weight:1.2,genre:"reggaeton"},{bpm:108,weight:1.2,genre:"moombahton"},{bpm:110,weight:1.2,genre:"reggaeton"},{bpm:115,weight:1.1,genre:"pop"},{bpm:120,weight:1.5,genre:"house"},{bpm:122,weight:1.3,genre:"house"},{bpm:124,weight:1.4,genre:"house"},{bpm:126,weight:1.4,genre:"house"},{bpm:128,weight:1.5,genre:"house/techno"},{bpm:130,weight:1.3,genre:"techno"},{bpm:135,weight:1.2,genre:"techno"},{bpm:140,weight:1.4,genre:"trance/dubstep"},{bpm:145,weight:1.2,genre:"trance"},{bpm:150,weight:1.1,genre:"hardstyle"},{bpm:160,weight:1.2,genre:"footwork"},{bpm:170,weight:1.1,genre:"drum & bass"},{bpm:172,weight:1.2,genre:"drum & bass"},{bpm:174,weight:1.3,genre:"drum & bass"},{bpm:180,weight:1.1,genre:"hardcore"}],e=[],o=[...t];Object.values(r).forEach(i=>{i&&!o.find(s=>Math.abs(s.bpm-i.bpm)<1)&&o.push(i)});for(const i of o.slice(0,10)){let s=i.score;const h=n.find(u=>Math.abs(u.bpm-i.bpm)<2);h&&(s*=h.weight,console.log(`  ‚≠ê ${i.bpm.toFixed(1)} BPM matches common ${h.genre} tempo (√ó${h.weight})`)),r.half_time&&Math.abs(i.bpm-r.half_time.bpm)<1&&(s*=.8),r.double_time&&Math.abs(i.bpm-r.double_time.bpm)<1&&(s*=.85),Math.abs(i.bpm-a)<10&&(s*=1.1),e.push({...i,adjustedScore:s,isCommon:!!h})}return e.sort((i,s)=>s.adjustedScore-i.adjustedScore),console.log("üìä Adjusted tempo scores:"),e.slice(0,5).forEach((i,s)=>{const h=i.isCommon?"‚≠ê":"";console.log(`  ${s+1}. ${i.bpm.toFixed(1)} BPM (adj: ${i.adjustedScore.toFixed(3)}, orig: ${i.score.toFixed(3)}) ${h}`)}),e[0].bpm}_resolveTempoConfusion(t,r){if(t.length<2)return null;const a=t[0].bpm,n=t[0].originalScore||t[0].score;if(console.log("üîç Checking for tempo confusion patterns..."),a>=85&&a<=87){const o=a*1.25,i=t.find(s=>Math.abs(s.bpm-o)<3);if(i&&i.originalScore>n*.6)return console.log(`  Pattern: ${a.toFixed(1)} vs ${i.bpm.toFixed(1)} (4:5 ratio)`),i.bpm}if(a>=92&&a<=95){const o=a*1.5,i=t.find(s=>Math.abs(s.bpm-o)<3);if(i&&i.originalScore>n*.5)return console.log(`  Pattern: ${a.toFixed(1)} vs ${i.bpm.toFixed(1)} (2:3 ratio)`),i.bpm}if(a>=77&&a<=80){const o=a*1.26,i=t.find(s=>Math.abs(s.bpm-o)<3);if(i&&i.originalScore>n*.6)return console.log(`  Pattern: ${a.toFixed(1)} vs ${i.bpm.toFixed(1)} (4:5 ratio)`),i.bpm}const e=[98,99,100,108,110,120,124,126,128,130,135,140,172,174];for(let o=1;o<Math.min(4,t.length);o++){const i=t[o];if(e.some(h=>Math.abs(i.bpm-h)<2)&&i.originalScore>n*.7)return console.log(`  Found common dance tempo: ${i.bpm.toFixed(1)} BPM with strong score`),i.bpm}return null}}class Ft{constructor(){this.tracker=new pt,this.audioContext=this.tracker.audioContext}detectDrumHits(t,r={}){const{threshold:a=.3,minInterval:n=.05,kickThreshold:e=.4,circular:o=!0}=r;console.log(`ü•Å Detecting drum hits with threshold ${a}${o?" (circular mode)":""}`);const i=t.getChannelData(0),s=t.sampleRate,h=2048,c=512,u=o?this._computeCircularOnsetStrength(i,s,c,h):this.tracker.onsetStrength(i,s,c),l=[],m=[],x=Math.max(...u)*a;let p=-n;for(let g=1;g<u.length-1;g++){const M=g*c/s;if(u[g]>x&&u[g]>u[g-1]&&u[g]>u[g+1]&&M-p>=n){const $=g*c,B=Math.min($+h,i.length),E=i.slice($,B),v=this._analyzeFrequencyContent(E);v.lowFreqRatio>e?(l.push(M),console.log(`ü¶µ Kick at ${M.toFixed(3)}s (low freq: ${(v.lowFreqRatio*100).toFixed(1)}%)`)):(m.push(M),console.log(`ü•Å Hit at ${M.toFixed(3)}s (low freq: ${(v.lowFreqRatio*100).toFixed(1)}%)`)),p=M}}return console.log(`ü•Å Found ${l.length} kicks and ${m.length} other hits`),{kicks:l,hits:m}}_computeCircularOnsetStrength(t,r,a,n){const e=Math.floor((t.length-n)/a)+1,o=new Float32Array(e);console.log(`üîÑ Computing circular onset strength for ${e} frames`);const i=4;let s=[];for(let c=e-i;c<e;c++){if(c<0)continue;const u=c*a,l=new Float32Array(n);for(let b=0;b<n&&u+b<t.length;b++){const x=.5*(1-Math.cos(2*Math.PI*b/(n-1)));l[b]=t[u+b]*x}const m=this.tracker._computeMagnitudeSpectrum(l);s.push(m)}let h=s.length>0?s[s.length-1]:null;for(let c=0;c<e;c++){const u=c*a,l=new Float32Array(n);for(let b=0;b<n&&u+b<t.length;b++){const x=.5*(1-Math.cos(2*Math.PI*b/(n-1)));l[b]=t[u+b]*x}const m=this.tracker._computeMagnitudeSpectrum(l);if(h){let b=0;for(let x=0;x<Math.min(m.length,h.length);x++)b+=Math.max(0,m[x]-h[x]);o[c]=b,c===0&&console.log(`üîÑ Frame 0 flux: ${b.toFixed(3)} (using end-of-track spectrum as previous)`)}else o[c]=0;h=m}return o}_analyzeFrequencyContent(t){const r=this.tracker._fft(t),a=r.length,n=Math.floor(a*.1),e=Math.floor(a*.3);let o=0,i=0,s=0;for(let c=0;c<a;c++){const u=Math.sqrt(r[c].real*r[c].real+r[c].imag*r[c].imag);c<n?o+=u:c<e?i+=u:s+=u}const h=o+i+s;return{lowFreqRatio:h>0?o/h:0,midFreqRatio:h>0?i/h:0,highFreqRatio:h>0?s/h:0}}generateDrumClickTrack(t,r,a=200,n=1e3,e=0){if(!this.audioContext)return null;const{kicks:o=[],hits:i=[]}=t;console.log(`üîä Generating drum click track: ${o.length} kicks (${a}Hz), ${i.length} hits (${n}Hz)`);const s=this.audioContext.sampleRate,h=Math.floor(r*s),c=this.audioContext.createBuffer(1,h,s),u=c.getChannelData(0);return o.forEach((l,m)=>{const b=l+e,x=Math.floor(b*s);if(x<0||x>=h)return;m<3&&console.log(`  ü¶µ Adding kick ${m} at ${b.toFixed(3)}s`);const g=Math.floor(.15*s);for(let M=0;M<g&&x+M<h;M++){const $=M/s,B=Math.exp(-20*$),E=Math.sin(2*Math.PI*a*$);u[x+M]+=B*E*.9}}),i.forEach((l,m)=>{const b=l+e,x=Math.floor(b*s);if(x<0||x>=h)return;m<3&&console.log(`  ü•Å Adding hit ${m} at ${b.toFixed(3)}s`);const g=Math.floor(.08*s);for(let M=0;M<g&&x+M<h;M++){const $=M/s,B=Math.exp(-40*$),E=Math.sin(2*Math.PI*n*$);u[x+M]+=B*E*.7}}),console.log("‚úÖ Generated combined drum click track"),c}generateClickTrack(t,r,a=660,n=0){if(!this.audioContext)return null;console.log(`üîä Generating click track: ${t.length} beats, ${r.toFixed(2)}s duration, ${a}Hz`);const e=this.audioContext.sampleRate,o=Math.floor(r*e),i=this.audioContext.createBuffer(1,o,e),s=i.getChannelData(0);if(!t||t.length===0)return console.warn("‚ö†Ô∏è No beats provided for click track generation"),i;let h=0;return t.forEach((c,u)=>{const l=c+n,m=Math.floor(l*e);if(m<0||m>=o){console.log(`  Skipping beat ${u} at ${l.toFixed(3)}s (outside buffer)`);return}(u<5||u===t.length-1)&&console.log(`  Adding click ${u} at ${l.toFixed(3)}s (sample ${m})`);const x=Math.floor(.25*e);let p=0;for(let g=0;g<x&&m+g<o;g++){const M=g/e,$=Math.exp(-35*M),B=Math.sin(2*Math.PI*a*M),E=$*B*.8;s[m+g]+=E,p=Math.max(p,Math.abs(E))}u<5&&console.log(`    Click ${u} max amplitude: ${p.toFixed(3)}`),h++}),console.log(`‚úÖ Added ${h} clicks to buffer`),i}playWithBeats(t,r){if(!this.audioContext)return;const a=this.audioContext.createBufferSource();a.buffer=t,a.connect(this.audioContext.destination);const n=this.generateClickTrack(r,t.duration);if(n){const e=this.audioContext.createBufferSource();e.buffer=n,e.connect(this.audioContext.destination);const o=this.audioContext.currentTime;a.start(o),e.start(o)}else a.start()}}const Ct=document.getElementById("fileInput"),Y=document.getElementById("playBtn"),ot=document.getElementById("stopBtn"),X=document.getElementById("analyzeBtn"),H=document.getElementById("clickBtn"),q=document.getElementById("drumBtn"),N=document.getElementById("kickBtn"),j=document.getElementById("hitBtn"),gt=document.getElementById("beatOffset"),Mt=document.getElementById("offsetDisplay"),Bt=document.getElementById("resetOffset"),_=document.getElementById("bpm"),st=document.getElementById("logOutput"),bt=document.getElementById("waveformCanvas"),Tt=document.getElementById("playhead"),dt=document.getElementById("collapseAllBtn"),ft=document.getElementById("expandAllBtn"),ct=document.getElementById("logToggle"),mt=document.getElementById("waveformToggle");let w,P,S,W,nt,rt,it,C=120,at=null,F=null,L=!1,D=!1,O=!1,z=!1,A=null,J=null,V=null,U=null,lt=null,K=0;const St=new pt,G=new Ft;function d(f){const t=new Date().toLocaleTimeString();st.textContent+=`[${t}] ${f}
`,st.scrollTop=st.scrollHeight,console.log(`[${t}] ${f}`)}function kt(){st.textContent=""}Ct.addEventListener("change",async f=>{const t=f.target.files[0];if(t)try{if(kt(),d("Loading audio file..."),!w||w.state==="closed")try{w=new AudioContext({sampleRate:48e3}),d("üìª Created AudioContext at 48kHz")}catch{w=new AudioContext,d(`üìª Created AudioContext at system rate: ${w.sampleRate}Hz`)}const r=await t.arrayBuffer();S=await w.decodeAudioData(r),_.textContent="BPM: --",d("‚úÖ Audio file loaded successfully"),d(`Duration: ${S.duration.toFixed(1)}s, Sample Rate: ${S.sampleRate}Hz`),d(`AudioContext Sample Rate: ${w.sampleRate}Hz`),A=null,J=null,V=null,U=null,D=!1,O=!1,z=!1,q.textContent="ü•Å All Drums",N.textContent="ü¶µ Kicks Only",j.textContent="ü•® Hits Only",Y.disabled=!1,X.disabled=!1,dt.disabled=!1,ft.disabled=!1}catch(r){console.error("File loading error:",r),_.textContent="BPM: Error",d("‚ùå Failed to load file: "+r.message)}});Y.onclick=async()=>{if(!S||!w){d("‚ùå No audio loaded");return}try{if(P&&P.stop(),w.state==="suspended"&&await w.resume(),P=w.createBufferSource(),P.buffer=S,P.loop=!0,P.connect(w.destination),Pt(),(!W||W.length===0)&&(d("üéµ Starting background beat analysis..."),setTimeout(()=>{X.onclick()},100)),L&&at?(F=w.createBufferSource(),F.buffer=at,F.loop=!0,F.connect(w.destination)):D&&J?(F=w.createBufferSource(),F.buffer=J,F.loop=!0,F.connect(w.destination)):O&&V?(F=w.createBufferSource(),F.buffer=V,F.loop=!0,F.connect(w.destination)):z&&U&&(F=w.createBufferSource(),F.buffer=U,F.loop=!0,F.connect(w.destination)),nt=w.currentTime,P.start(),F){F.start();let f="clicks";L?f="click track":D?f="all drums":O?f="kicks only":z&&(f="hits only"),d(`‚ñ∂Ô∏è Audio playback started with ${f}`),xt()}else d("‚ñ∂Ô∏è Audio playback started");Y.disabled=!0,ot.disabled=!1,Gt(),At()}catch(f){console.error("Playback error:",f),d("‚ùå Playback failed: "+f.message)}};ot.onclick=()=>{P&&(P.stop(),P=null),F&&(F.stop(),F=null),d("‚èπÔ∏è Audio playback stopped"),Y.disabled=!1,ot.disabled=!0,Kt(),Lt(),ut()};X.onclick=async()=>{if(S)try{X.disabled=!0,Y.disabled=!0;const f=S.getChannelData(0),t=S.sampleRate,r=f.length>t*30,a=r?8:4,n=r?2:1;_.textContent="BPM: Analyzing...",kt(),d("üîç Starting BPM analysis"),d(`Audio: ${f.length.toLocaleString()} samples (${(f.length/t).toFixed(1)}s)`),d(`Window: ${a}s, Hop: ${n}s`),r&&d("‚ö° Large file detected - using optimized analysis");const e=performance.now(),o=await _t(f,t,a,n),i=(performance.now()-e)/1e3;if(o.success){const{times:s,tempo:h,globalTempo:c,confidence:u,candidates:l,tempogram:m,onsetEnvelope:b}=o;d(`‚úÖ Analysis completed in ${i.toFixed(1)}s`),C=parseFloat(c.toFixed(1)),(isNaN(C)||C<30||C>300)&&(d(`‚ö†Ô∏è Invalid tempo detected: ${C}, using default 120 BPM`),C=120),d(`üéØ GLOBAL TEMPO: ${C} BPM (${(u*100).toFixed(1)}% confidence)`),d("üèÜ Final global tempo candidates (raw autocorrelation only):");for(let k=0;k<Math.min(l.length,5);k++){const y=l[k],T=Math.abs(y.bpm-C)<.1?"üëë":"";d(` ${k+1}. ${y.bpm.toFixed(1)} BPM (score: ${y.score.toFixed(4)}) ${T}`)}if(d("üìà FOURIER TEMPOGRAM ANALYSIS:"),d(` Time-frequency resolution: ${m.frames} frames √ó ${m.frequencies.length} frequencies`),d(` Total spectral energy: ${m.totalEnergy.toFixed(3)}`),d(" Energy distribution:"),m&&m.peakTempos&&m.peakTempos.length>0){d("üéº TEMPOGRAM PEAK TEMPOS (spectral analysis):");for(let T=0;T<Math.min(m.peakTempos.length,8);T++){const I=m.peakTempos[T],R=Math.abs(I.bpm-C)<5?"üéØ":"",et=I.frameCount||0,wt=m.frames||1;d(` ${T+1}. ${I.bpm.toFixed(1)} BPM (energy: ${I.energy.toFixed(4)}, frames: ${et}/${wt} frames, ${(I.prominence*100).toFixed(1)}%) ${R}`)}const k=m.peakTempos[0],y=Math.abs(k.bpm-C);d(`üîç Method agreement: Global=${C.toFixed(1)} vs Tempogram=${k.bpm.toFixed(1)} BPM (¬±${y.toFixed(1)})`),y<5?d("‚úÖ EXCELLENT: Both methods agree within ¬±5 BPM"):y<15?d("‚ö†Ô∏è MODERATE: Methods agree within ¬±15 BPM"):d("‚ùå DISAGREEMENT: Methods differ by >15 BPM - complex tempo")}else d(" ‚ùì No clear peaks found in tempogram - complex/weak tempo");const x=h.map(k=>Math.abs(k-C)),p=x.reduce((k,y)=>k+y,0)/x.length,g=Math.max(...x);d("üìä TEMPO STABILITY ANALYSIS:"),d(` Average deviation: ¬±${p.toFixed(1)} BPM`),d(` Maximum deviation: ¬±${g.toFixed(1)} BPM`),d(` Stability windows: ${h.filter(k=>Math.abs(k-C)<5).length}/${h.length} stable (¬±5 BPM)`),d("üìà WINDOW-BY-WINDOW SUMMARY:");const M=h.filter(k=>Math.abs(k-C)<5).length,$=h.filter(k=>Math.abs(k-C)>=5&&Math.abs(k-C)<15).length,B=h.filter(k=>Math.abs(k-C)>=15).length;d(` ‚úÖ Stable (¬±5 BPM): ${M} windows`),d(`   ‚ö†Ô∏è Moderate (5-15 BPM): ${$} windows`),d(`   ‚ùå Unstable (>15 BPM): ${B} windows`),d("üéµ Performing beat tracking (reusing onset envelope)..."),W=St.beatTrack({y:f,sr:t,onsetEnvelope:b,hopLength:512,startBpm:C,tightness:100,trim:!0,units:"time",sparse:!0}).beats,d(`ü•Å Beat tracking completed: ${W.length} beats detected`),d("üéµ Generating click track for verification..."),at=G.generateClickTrack(W,S.duration,660,K),d(`‚úÖ Click track generated successfully with ${W.length} clicks`),H.disabled=!1;let v;const Q=m&&m.peakTempos&&m.peakTempos.length>0&&Math.abs(m.peakTempos[0].bpm-C)<10;u>.4?v="DETECTED":u>.2?v="LIKELY":v="ESTIMATE",Q&&(v+=" ‚úì"),_.textContent=`BPM: ${C} (${v})`,d("üéâ FINAL RESULT:"),u>.7&&Q?d(` üéØ HIGH CONFIDENCE: Both methods confirm ${C.toFixed(1)} BPM`):u>.4?d(`   ‚ö†Ô∏è MODERATE CONFIDENCE: Track is likely ${C.toFixed(1)} BPM`):d(` ‚ùì LOW CONFIDENCE: Complex/ambiguous tempo, best guess ${C.toFixed(1)} BPM`);const tt=p<5?"STABLE":p<15?"MODERATE":"VARIABLE";d(`   üìä Overall stability: ${tt} (¬±${p.toFixed(1)} BPM average)`),m&&m.peakTempos&&m.peakTempos.length>1&&d("   üéº Multiple tempo candidates detected - possible tempo changes or polyrhythm")}else throw new Error(o.error)}catch(f){console.error("Analysis error:",f),_.textContent="BPM: Error",d("‚ùå Analysis failed: "+f.message)}finally{X.disabled=!1,Y.disabled=!1}};H.onclick=()=>{L=!L,D=!1,O=!1,z=!1,H.textContent=L?"üîä Click Track":"üîá Click Track",q.textContent="ü•Å All Drums",N.textContent="ü¶µ Kicks Only",j.textContent="ü•® Hits Only",P&&w&&Z(),d(`üéµ Click track ${L?"enabled":"disabled"}`)};q.onclick=async()=>{if(!S){d("‚ùå No audio loaded for drum detection");return}if(D=!D,L=!1,O=!1,z=!1,H.textContent="üîá Click Track",q.textContent=D?"üîä All Drums":"ü•Å All Drums",N.textContent="ü¶µ Kicks Only",j.textContent="ü•® Hits Only",D&&!A){d("ü•Å Detecting all drum hits..."),q.disabled=!0,N.disabled=!0,j.disabled=!0;try{A=G.detectDrumHits(S,{threshold:.3,minInterval:.05,kickThreshold:.4}),d(`‚úÖ Found ${A.kicks.length} kicks and ${A.hits.length} other hits`),J=G.generateDrumClickTrack(A,S.duration,200,1e3,K),V=G.generateDrumClickTrack({kicks:A.kicks,hits:[]},S.duration,200,1e3,K),U=G.generateDrumClickTrack({kicks:[],hits:A.hits},S.duration,200,1e3,K),d("üîä Generated all drum click tracks")}catch(f){console.error("Drum detection error:",f),d("‚ùå Drum detection failed: "+f.message),D=!1,q.textContent="ü•Å All Drums"}finally{q.disabled=!1,N.disabled=!1,j.disabled=!1}}P&&w&&Z(),d(`ü•Å Drum hit mode ${D?"enabled":"disabled"}`)};N.onclick=async()=>{if(!S){d("‚ùå No audio loaded for kick detection");return}if(O=!O,L=!1,D=!1,z=!1,H.textContent="üîá Click Track",q.textContent="ü•Å All Drums",N.textContent=O?"üîä Kicks Only":"ü¶µ Kicks Only",j.textContent="ü•® Hits Only",O&&!A){d("ü¶µ Detecting drum hits for kick isolation..."),N.disabled=!0,q.disabled=!0,j.disabled=!0;try{A=G.detectDrumHits(S,{threshold:.3,minInterval:.05,kickThreshold:.4}),d(`‚úÖ Found ${A.kicks.length} kicks and ${A.hits.length} other hits`),V||(V=G.generateDrumClickTrack({kicks:A.kicks,hits:[]},S.duration,200,1e3,K),d("üîä Generated kick click track"))}catch(f){console.error("Kick detection error:",f),d("‚ùå Kick detection failed: "+f.message),O=!1,N.textContent="ü¶µ Kicks Only"}finally{N.disabled=!1,q.disabled=!1,j.disabled=!1}}P&&w&&Z(),d(`ü¶µ Kick only mode ${O?"enabled":"disabled"} (${(A==null?void 0:A.kicks.length)||0} kicks)`)};j.onclick=async()=>{if(!S){d("‚ùå No audio loaded for hit detection");return}if(z=!z,L=!1,D=!1,O=!1,H.textContent="üîá Click Track",q.textContent="ü•Å All Drums",N.textContent="ü¶µ Kicks Only",j.textContent=z?"üîä Hits Only":"ü•® Hits Only",z&&!A){d("ü•® Detecting drum hits for snare/hat isolation..."),j.disabled=!0,q.disabled=!0,N.disabled=!0;try{A=G.detectDrumHits(S,{threshold:.3,minInterval:.05,kickThreshold:.4}),d(`‚úÖ Found ${A.kicks.length} kicks and ${A.hits.length} other hits`),U||(U=G.generateDrumClickTrack({kicks:[],hits:A.hits},S.duration,200,1e3,K),d("üîä Generated hit click track"))}catch(f){console.error("Hit detection error:",f),d("‚ùå Hit detection failed: "+f.message),z=!1,j.textContent="ü•® Hits Only"}finally{j.disabled=!1,q.disabled=!1,N.disabled=!1}}P&&w&&Z(),d(`ü•® Hit only mode ${z?"enabled":"disabled"} (${(A==null?void 0:A.hits.length)||0} hits)`)};gt.oninput=f=>{K=parseFloat(f.target.value)/1e3,Mt.textContent=`${f.target.value}ms`,P&&L&&Z()};Bt.onclick=()=>{gt.value=0,K=0,Mt.textContent="0ms",P&&L&&Z()};function Z(){if(!P||!w)return;const f=w.currentTime-nt;P&&P.stop(),F&&F.stop();try{P=w.createBufferSource(),P.buffer=S,P.loop=!0,P.connect(w.destination),F=null,L&&at?(F=w.createBufferSource(),F.buffer=at,F.loop=!0,F.connect(w.destination)):D&&J?(F=w.createBufferSource(),F.buffer=J,F.loop=!0,F.connect(w.destination)):O&&V?(F=w.createBufferSource(),F.buffer=V,F.loop=!0,F.connect(w.destination)):z&&U&&(F=w.createBufferSource(),F.buffer=U,F.loop=!0,F.connect(w.destination)),nt=w.currentTime-f,P.start(),F?(F.start(),xt()):ut(),d(`üîÑ Playback restarted with ${L?"click track":D?"drum hits":"no clicks"}`)}catch(t){console.error("Restart playback error:",t),ot.onclick()}}function Pt(){if(!w)return;const f=w.createAnalyser();f.fftSize=4096,f.smoothingTimeConstant=.3,P.connect(f),Math.floor(2*w.sampleRate),d("üé§ Live audio analysis setup complete")}function At(){if(!C||C<=0){d("‚ùå No global tempo available for live tracking - run analysis first"),d(`Debug: globalTempo = ${C}`);return}let f=0;const t=1.5,r=2;(!W||W.length===0)&&(d("‚ö†Ô∏è No beat analysis available - please run analysis first"),C=120,W=[],_.textContent="BPM: -- (No analysis)"),it=setInterval(async()=>{const a=w.currentTime-nt,n=a%S.duration;if(a-f>=t)try{const e=await vt(n,r);if(e&&e>0){const o=Math.abs(e-C);let i;o<3?(i="LIVE ‚úÖ",_.textContent=`BPM: ${C.toFixed(1)} (${i})`):o<8?(i="LIVE ~",_.textContent=`BPM: ${C.toFixed(1)} (${i})`):(i="LIVE ?",_.textContent=`BPM: ${C.toFixed(1)} (TRACKING)`);const s=o>.5?` (${e>C?"+":""}${(e-C).toFixed(1)})`:"";d(`üéµ Live: ${e.toFixed(1)} BPM${s} at ${n.toFixed(1)}s`)}else{const o=ht(n);_.textContent=`BPM: ${o} (TRACKING)`}f=a}catch(e){console.warn("Live BPM analysis failed:",e);const o=ht();_.textContent=`BPM: ${o} (TRACKING)`}else{const e=ht();_.textContent=`BPM: ${e} (TRACKING)`}},500),d("üéØ Enhanced live BPM tracking started (DAW-style)")}async function vt(f,t){if(!S)return null;const r=S.sampleRate,a=Math.floor(t*r),n=Math.floor(f*r),e=new Float32Array(a),o=S.getChannelData(0);for(let u=0;u<a;u++){const l=(n+u)%o.length;e[u]=o[l]}const i=await Et(e),s=20,h=Math.max(60,C-s),c=Math.min(200,C+s);return await Rt(i,r,C,h,c)}async function Et(f,t){const n=Math.floor((f.length-2048)/512)+1,e=new Float32Array(n);let o=null;for(let i=0;i<n;i++){const s=i*512,h=new Float32Array(2048);for(let u=0;u<2048&&s+u<f.length;u++)h[u]=f[s+u]*.5*(1-Math.cos(2*Math.PI*u/2048));const c=It(h);if(o){let u=0;for(let l=0;l<c.length;l++)u+=Math.max(0,c[l]-o[l]);e[i]=u}o=c}return e}function It(f){const t=new Float32Array(f.length/8);for(let r=0;r<t.length;r++){let a=0,n=0;const e=2;for(let o=0;o<f.length;o+=e){const i=-2*Math.PI*r*o/f.length;a+=f[o]*Math.cos(i),n+=f[o]*Math.sin(i)}t[r]=Math.sqrt(a*a+n*n)}return t}async function Rt(f,t,r,a,n){const o=Math.floor(60*t/(n*512)),i=Math.floor(60*t/(a*512));if(f.length<i*2)return r;let s=r,h=0;for(let u=o;u<Math.min(i,f.length/2);u++){let l=0,m=0;for(let p=0;p<f.length-u;p++)l+=f[p]*f[p+u],m+=f[p]*f[p];const b=m>0?l/m:0,x=60*t/(u*512);b>h&&x>=a&&x<=n&&(h=b,s=x)}return h<.2?r:(Math.abs(s-r)>5&&(s=r+(s-r)*.5),s)}function ht(f){return C?C.toFixed(1):"120"}function Lt(){it&&(clearInterval(it),it=null,_.textContent="BPM: --",d("‚èπÔ∏è Live BPM tracking stopped"))}function xt(){if(!C||!L)return;ut();const f=60/C*1e3;d(`üåü Starting button pulse at ${C} BPM (${f.toFixed(0)}ms intervals)`),lt=setInterval(()=>{L&&H&&(H.classList.add("pulse-glow"),setTimeout(()=>{H.classList.remove("pulse-glow")},150))},f)}function ut(){lt&&(clearInterval(lt),lt=null,H.classList.remove("pulse-glow"),d("‚≠ê Button pulse stopped"))}async function _t(f,t,r,a){try{d("üéµ Step 1: Computing onset strength for entire track..."),d(`üìä Track info: ${f.length.toLocaleString()} samples, ${(f.length/t).toFixed(1)}s duration`);const n=await Dt(f,t);d(`‚úÖ Onset envelope computed: ${n.length} frames`),d(`üìà Onset stats: max=${Math.max(...n).toFixed(3)}, avg=${(n.reduce((l,m)=>l+m,0)/n.length).toFixed(3)}`),d("üéµ Step 2: Finding global tempo candidates...");const e=await Ot(n,t);d(`üéØ Global tempo: ${e.bpm.toFixed(1)} BPM (confidence: ${(e.confidence*100).toFixed(1)}%)`),d(`üîç Best correlation score: ${e.score.toFixed(4)}`),d("üìä Top tempo candidates:");for(let l=0;l<Math.min(e.candidates.length,5);l++){const m=e.candidates[l];d(` ${l+1}. ${m.bpm.toFixed(1)} BPM (score: ${m.score.toFixed(4)})`)}d("üéµ Step 3: Computing Fourier tempogram for detailed tempo analysis...");const o=await zt(n,t);d(`üìà Tempogram computed: ${o.frames} time frames, ${o.frequencies.length} tempo frequencies`),d(`üéØ Tempogram tempo range: ${o.tempoRange.min.toFixed(1)}-${o.tempoRange.max.toFixed(1)} BPM`),d("üìä Peak tempo energies in tempogram:");for(let l=0;l<Math.min(o.peakTempos.length,5);l++){const m=o.peakTempos[l];d(` ${l+1}. ${m.bpm.toFixed(1)} BPM (energy: ${m.energy.toFixed(4)}, frames: ${m.frameCount})`)}d("üéµ Step 4: Analyzing tempo stability over time...");const i=Math.floor(r*t),s=Math.floor(a*t),h=Math.floor((f.length-i)/s);d(`‚öôÔ∏è Window analysis: ${h} windows, ${r}s each, ${a}s hops`);const c=[],u=[];for(let l=0;l<h;l++){const m=l*s,b=f.slice(m,m+i),x=await Ht(b,t,e.bpm,l);c.push(x.bpm),u.push(m/t);const p=Math.abs(x.bpm-e.bpm),g=p<3?"‚úÖ":p<8?"‚ö†Ô∏è":"‚ùå",M=p>.1?` (${p>0?"+":""}${(x.bpm-e.bpm).toFixed(1)})`:"";d(`[${l.toString().padStart(2,"0")}] t=${u[l].toFixed(1)}s ‚Üí ${x.bpm.toFixed(1)} BPM${M} ${g} (corr: ${x.correlation.toFixed(3)})`);const $=(l/h*100).toFixed(0);_.textContent=`BPM: ${e.bpm.toFixed(1)} (${$}% analyzed)`,l%2===0&&await new Promise(B=>setTimeout(B,10))}return{success:!0,times:u,tempo:c,globalTempo:e.bpm,confidence:e.confidence,candidates:e.candidates,tempogram:o,onsetEnvelope:n}}catch(n){return{success:!1,error:n.message}}}async function Dt(f,t){const n=Math.floor((f.length-2048)/512)+1,e=new Float32Array(n);d(`üîß Onset computation: ${n} frames, 2048 frame size, 512 hop`);let o=null,i=0;for(let s=0;s<n;s++){const h=s*512,c=new Float32Array(2048);for(let l=0;l<2048&&h+l<f.length;l++){const m=.5*(1-Math.cos(2*Math.PI*l/2047));c[l]=f[h+l]*m}const u=Wt(c);if(o){let l=0;for(let m=0;m<Math.min(u.length,o.length);m++)l+=Math.max(0,u[m]-o[m]);e[s]=l,i=Math.max(i,l)}else e[s]=0;if(o=u,s%200===0){const l=(s/n*100).toFixed(0);d(` Computing onsets... ${l}% (frame ${s}/${n}, flux: ${e[s].toFixed(3)})`),await new Promise(m=>setTimeout(m,1))}}return d(`üìä Onset envelope: max flux = ${i.toFixed(3)}`),e}async function Ot(f,t){const a={min:70,max:180},n=Math.floor(60*t/(a.max*512)),e=Math.floor(60*t/(a.min*512));d(`üîç Searching tempo range: ${a.min}-${a.max} BPM`),d(`üìä Autocorrelation: ${n} to ${e} lag frames (${e-n+1} calculations)`),d("‚ö° Using RAW autocorrelation scores only - no arbitrary musical boosts");const o=new Float32Array(e-n+1),i=[];for(let l=0;l<o.length;l++){const m=n+l;let b=0,x=0;for(let g=0;g<f.length-m;g++)b+=f[g]*f[g+m],x+=f[g]*f[g];o[l]=x>0?b/x:0;const p=60*t/(m*512);if(i.push({bpm:p,score:o[l],lag:m}),l%20===0){const g=(l/o.length*100).toFixed(0);d(` Autocorr ${g}%: lag=${m} ‚Üí ${p.toFixed(1)} BPM (corr: ${o[l].toFixed(4)})`),await new Promise(M=>setTimeout(M,1))}}d("üéØ Finding tempo peaks with musical constraints..."),i.sort((l,m)=>m.score-l.score),d("üìà Raw autocorrelation peaks:");for(let l=0;l<Math.min(10,i.length);l++)d(` ${l+1}. ${i[l].bpm.toFixed(1)} BPM (score: ${i[l].score.toFixed(4)})`);let s=120,h=0;for(let l=0;l<i.length;l++)i[l].score>h&&(h=i[l].score,s=i[l].bpm);i.sort((l,m)=>m.score-l.score),d("üéµ Final ranking by RAW autocorrelation only (no boosts):");for(let l=0;l<Math.min(5,i.length);l++){const m=Math.abs(i[l].bpm-s)<.1?" üëë":"";d(` ${l+1}. ${i[l].bpm.toFixed(1)} BPM (raw score: ${i[l].score.toFixed(4)})${m}`)}const c=o.reduce((l,m)=>l+m,0)/o.length,u=Math.min(1,Math.max(0,(h-c)/(.3+c*.5)));return d(`üìä Confidence calculation: best=${h.toFixed(4)}, avg=${c.toFixed(4)} ‚Üí ${(u*100).toFixed(1)}%`),{bpm:Math.max(a.min,Math.min(a.max,s)),confidence:u,score:h,candidates:i.slice(0,10)}}async function zt(f,t){const n=Math.floor(96);d(`üîß Tempogram setup: winLength=384, hopFrames=${n}`);const e=Math.floor((f.length-384)/n)+1,o=[],i=new Float32Array(384);for(let c=0;c<384;c++)i[c]=.5-.5*Math.cos(2*Math.PI*c/383);d(`üìä Computing ${e} tempogram frames...`);for(let c=0;c<e;c++){const u=c*n,l=new Float32Array(384);for(let b=0;b<384&&u+b<f.length;b++)l[b]=f[u+b]*i[b];const m=Nt(l);if(o.push(m),c%Math.max(1,Math.floor(e/10))===0){const b=(c/e*100).toFixed(0),x=l.reduce((p,g)=>p+g*g,0);d(` Tempogram ${b}%: frame ${c}/${e} (energy: ${x.toFixed(3)})`),await new Promise(p=>setTimeout(p,1))}}const s=qt(t,512,384);d(`üéº Tempo frequency range: ${s[1].toFixed(1)}-${s[s.length-1].toFixed(1)} BPM`);const h=jt(o,s);return d("üìà Tempogram analysis complete:"),d(` Dominant frequencies found: ${h.peakTempos.length}`),d(` Total energy: ${h.totalEnergy.toFixed(3)}`),d(` Peak energy ratio: ${(h.peakEnergyRatio*100).toFixed(1)}%`),{frames:e,tempogram:o,frequencies:s,tempoRange:{min:s[1],max:s[s.length-1]},peakTempos:h.peakTempos,totalEnergy:h.totalEnergy,energyDistribution:h.energyDistribution}}function qt(f,t,r){const a=Math.floor(r/2)+1,n=new Float32Array(a);for(let e=0;e<a;e++)n[e]=e*f/(r*t)*60;return n}function Nt(f){const t=f.length,r=[];for(let a=0;a<t;a++){let n=0,e=0;for(let o=0;o<t;o+=1){const i=-2*Math.PI*a*o/t;n+=f[o]*Math.cos(i),e+=f[o]*Math.sin(i)}r.push({real:n,imag:e})}return r}function jt(f,t){if(!f||f.length===0)return console.warn("‚ö†Ô∏è Empty tempogram, skipping analysis"),{peakTempos:[],totalEnergy:0,peakEnergyRatio:0,energyDistribution:{totalEnergy:0,peakEnergy:0,peakRatio:0,numPeaks:0},magnitudes:[]};const r=f.length,a=f[0].length,n=[];let e=0;for(let c=0;c<r;c++){const u=[];for(let l=0;l<a;l++){const m=Math.sqrt(f[c][l].real*f[c][l].real+f[c][l].imag*f[c][l].imag);u.push(m),e+=m}n.push(u)}const o=new Float32Array(a);for(let c=0;c<a;c++){let u=0;for(let l=0;l<r;l++)u+=n[l][c];o[c]=u/r}const i=[];for(let c=1;c<a-1;c++){const u=t[c];if(u>=60&&u<=200){const l=o[c];if(l>o[c-1]&&l>o[c+1]&&l>.01*Math.max(...o)){let b=0;for(let x=0;x<r;x++)n[x][c]>.5*l&&b++;i.push({bpm:u,energy:l,bin:c,frameCount:b,prominence:l/Math.max(...o)})}}}i.sort((c,u)=>u.energy-c.energy);const s=i.reduce((c,u)=>c+u.energy,0),h=e>0?s/e:0;return{peakTempos:i,totalEnergy:e,peakEnergyRatio:h,energyDistribution:{totalEnergy:e,peakEnergy:s,peakRatio:h,numPeaks:i.length},magnitudes:n}}async function Ht(f,t,r,a){const e=Math.max(60,r-50),o=Math.min(200,r+50);d(` [${a}] WIDE constraint: ${e.toFixed(1)}-${o.toFixed(1)} BPM (¬±50 around global ${r.toFixed(1)})`);const i=1024,s=256,h=[];let c=0;for(let g=0;g<f.length-i;g+=s){let M=0;for(let B=g;B<g+i&&B<f.length;B++)M+=f[B]*f[B];const $=Math.sqrt(M);h.push($),c+=$}const u=c/h.length;d(` [${a}] Onset energy: ${h.length} frames, avg=${u.toFixed(3)}, max=${Math.max(...h).toFixed(3)}`);const l=Math.floor(60*t/(o*s)),m=Math.floor(60*t/(e*s));d(` [${a}] Checking lags ${l}-${m} for ALL tempo candidates...`);let b=r,x=0;const p=[];for(let g=l;g<Math.min(m,h.length/2);g++){let M=0,$=0;for(let v=0;v<h.length-g;v++)M+=h[v]*h[v+g],$+=h[v]*h[v];const B=$>0?M/$:0,E=60*t/(g*s);p.push({bpm:E,correlation:B,lag:g}),B>x&&E>=e&&E<=o&&(x=B,b=E)}p.sort((g,M)=>M.correlation-g.correlation),d(` [${a}] Top correlations in window (all candidates):`);for(let g=0;g<Math.min(5,p.length);g++){const M=p[g],$=Math.abs(M.bpm-r)<10?"üéØ":"",B=Math.abs(M.bpm-b)<.1?"üëë":"";d(` ${M.bpm.toFixed(1)} BPM: ${M.correlation.toFixed(4)} ${$}${B}`)}return d(` [${a}] Selected: ${b.toFixed(1)} BPM (correlation: ${x.toFixed(4)})`),{bpm:b,correlation:x,candidates:p.slice(0,5)}}function Wt(f){const t=new Float32Array(f.length/2);for(let r=0;r<t.length;r++){let a=0,n=0;for(let e=0;e<f.length;e+=4){const o=-2*Math.PI*r*e/f.length;a+=f[e]*Math.cos(o),n+=f[e]*Math.sin(o)}t[r]=Math.sqrt(a*a+n*n)}return t}function Gt(){if(!S)return;const f=bt,t=f.getContext("2d"),r=f.width,a=f.height;t.clearRect(0,0,r,a);const n=S.getChannelData(0),e=Math.min(...n),o=Math.max(...n),i=n.map(s=>(s-e)/(o-e));t.beginPath(),t.moveTo(0,a/2);for(let s=0;s<r;s++){const h=s/r*n.length,c=a-(i[Math.floor(h)]+1)/2*a;t.lineTo(s,c)}t.strokeStyle="#007bff",t.lineWidth=2,t.stroke(),yt()}function yt(){if(!P||!S)return;const t=(w.currentTime-nt)%S.duration/S.duration*bt.width;Tt.style.left=`${t}px`,rt=requestAnimationFrame(yt)}function Kt(){rt&&(cancelAnimationFrame(rt),rt=null)}function $t(f,t){const r=document.getElementById(f),a=r.style.display==="none";r.style.display=a?"block":"none",t.textContent=a?"‚ñº Collapse":"‚ñ∂ Expand"}dt.onclick=()=>{document.getElementById("logOutput").style.display="none",document.getElementById("waveformContainer").style.display="none",ct.textContent="‚ñ∂ Expand",mt.textContent="‚ñ∂ Expand",d("‚è¨ All sections collapsed")};ft.onclick=()=>{document.getElementById("logOutput").style.display="block",document.getElementById("waveformContainer").style.display="block",ct.textContent="‚ñº Collapse",mt.textContent="‚ñº Collapse",d("‚è´ All sections expanded")};ct.onclick=()=>$t("logOutput",ct);mt.onclick=()=>$t("waveformContainer",mt);Y.disabled=!0;ot.disabled=!0;X.disabled=!0;H.disabled=!0;dt.disabled=!0;ft.disabled=!0;
