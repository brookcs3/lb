<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live BPM with XA Tracker</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    #bpm { font-size: 2rem; margin: 1rem 0; }
    button { font-size: 1rem; margin: 0.5rem; padding: 0.5rem 1rem; }
  </style>
</head>
<body>
  <h1>Live BPM Detector (XA)</h1>
  <input type="file" id="fileInput" accept="audio/*" />
  <div>
    <button id="playBtn">▶ Play</button>
    <button id="stopBtn">■ Stop</button>
  </div>
  <div id="bpm">BPM: --</div>

  <script type="module">
    import { BeatTracker } from './xa-beat-tracker.js';

    const fileInput = document.getElementById('fileInput');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const bpmDisplay = document.getElementById('bpm');

    let audioContext, sourceNode, audioBuffer, intervalId;
    const  tracker = new BeatTracker();
    let stableBpm = null, lastBpm = null, sameCount = 0;

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      audioContext = new AudioContext();
      const arrayBuffer = await file.arrayBuffer();
      audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
      bpmDisplay.textContent = 'BPM: --';
    });

    playBtn.onclick = () => {
      if (!audioBuffer || !audioContext) {
        console.error('No audio buffer or context available');
        bpmDisplay.textContent = 'BPM: No audio loaded';
        return;
      }

      try {
        // Stop existing playback if any
        if (sourceNode) sourceNode.stop();

        // Log audio buffer details
        console.log('Audio Buffer Details:', {
          duration: audioBuffer.duration,
          numberOfChannels: audioBuffer.numberOfChannels,
          sampleRate: audioBuffer.sampleRate,
          length: audioBuffer.length
        });

        // Create and setup source node
        sourceNode = audioContext.createBufferSource();
        sourceNode.buffer = audioBuffer;
        sourceNode.loop = true;
        sourceNode.connect(audioContext.destination);
        sourceNode.start();

        // Get audio data from the first channel
        const audioData = audioBuffer.getChannelData(0);
        
        // Check if we have valid audio data
        console.log('Audio Data Check:', {
          length: audioData.length,
          hasData: audioData.some(x => x !== 0),
          firstFewSamples: audioData.slice(0, 5)
        });

        // Try to detect BPM using the tracker instance
        const { tempo, beats } = tracker.beatTrack({
          y: audioData,
          sr: audioBuffer.sampleRate,
          hopLength: 512,
          units: 'time',
          sparse: true
        });

        console.log('Beat Detection Results:', {
          tempo: tempo,
          numberOfBeats: beats.length,
          firstFewBeats: beats.slice(0, 5)
        });

        if (tempo) {
          // Stabilize BPM reading
          if (lastBpm === tempo) {
            sameCount++;
            if (sameCount >= 3 && !stableBpm) {
              stableBpm = tempo;
            }
          } else {
            lastBpm = tempo;
            sameCount = 1;
          }

          // Display stable BPM if available, otherwise show current
          const displayBpm = stableBpm || tempo;
          bpmDisplay.textContent = `BPM: ${typeof displayBpm === 'number' ? displayBpm.toFixed(2) : 'Invalid tempo'}`;
        } else {
          bpmDisplay.textContent = 'BPM: No tempo detected';
        }

      } catch (error) {
        console.error('Detailed error in BPM detection:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        bpmDisplay.textContent = 'BPM: Error detecting tempo';
      }
    };

    stopBtn.onclick = () => {
      if (sourceNode) sourceNode.stop();
      sourceNode = null;
      clearInterval(intervalId);
      bpmDisplay.textContent = 'BPM: --';
    };
  </script>
</body>
</html>