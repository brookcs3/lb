<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live BPM with XA Tracker</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    #bpm { font-size: 2rem; margin: 1rem 0; }
    button { font-size: 1rem; margin: 0.5rem; padding: 0.5rem 1rem; }
  </style>
</head>
<body>
  <h1>Live BPM Detector (XA)</h1>
  <input type="file" id="fileInput" accept="audio/*" />
  <div>
    <button id="playBtn">▶ Play</button>
    <button id="stopBtn">■ Stop</button>
  </div>
  <div id="bpm">BPM: --</div>

  <script type="module">
    import { BeatTracker } from './xa-beat-tracker.js';

    const fileInput = document.getElementById('fileInput');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const bpmDisplay = document.getElementById('bpm');

    let audioContext, sourceNode, audioBuffer, intervalId;
    const tracker = new BeatTracker();
    let stableBpm = null, lastBpm = null, sameCount = 0;

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      audioContext = new AudioContext();
      const arrayBuffer = await file.arrayBuffer();
      audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
      bpmDisplay.textContent = 'BPM: --';
    });

    playBtn.onclick = () => {
      if (!audioBuffer || !audioContext) return;
      if (sourceNode) sourceNode.stop();

      // Create and play the audio
      sourceNode = audioContext.createBufferSource();
      sourceNode.buffer = audioBuffer;
      sourceNode.loop = true;
      sourceNode.connect(audioContext.destination);
      sourceNode.start();

      // Get BPM with proper error handling
      try {
        // Get the audio data
        const audioData = audioBuffer.getChannelData(0);
        
        // Use quickBeatTrack to analyze
        const result = quickBeatTrack(audioData, audioBuffer.sampleRate);
        
        // Log the full result to see what we get
        console.log('Beat tracking result:', result);
        
        // Update the display
        if (result && result.bpm) {
          bpmDisplay.textContent = `BPM: ${result.bpm.toFixed(2)}`;
        } else {
          bpmDisplay.textContent = 'BPM: No tempo detected';
        }
      } catch (error) {
        console.error('Error detecting BPM:', error);
        bpmDisplay.textContent = 'BPM: Error detecting tempo';
      }
    };

    stopBtn.onclick = () => {
      if (sourceNode) sourceNode.stop();
      sourceNode = null;
      clearInterval(intervalId);
      bpmDisplay.textContent = 'BPM: --';
    };
  </script>
</body>
</html>